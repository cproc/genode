qt5_qtwebkit.patch

From: Christian Prochaska <christian.prochaska@genode-labs.com>


---
 qtbase/src/network/access/qhttpnetworkreply.cpp    |    8 +++++++
 .../Source/JavaScriptCore/dfg/DFGOperations.cpp    |    1 +
 qtwebkit/Source/WTF/wtf/Assertions.h               |   11 ++++++++++
 qtwebkit/Source/WTF/wtf/ExportMacros.h             |    4 ++--
 qtwebkit/Source/WTF/wtf/InlineASM.h                |    5 +++--
 qtwebkit/Source/WTF/wtf/OSAllocatorPosix.cpp       |   13 ++++++++++++
 qtwebkit/Source/WTF/wtf/OSRandomSource.cpp         |    8 +++++++
 qtwebkit/Source/WTF/wtf/Platform.h                 |   22 ++++++++++++++++++--
 qtwebkit/Source/WTF/wtf/StackBounds.cpp            |   12 +++++++++++
 qtwebkit/Source/WTF/wtf/TCSystemAlloc.cpp          |   21 +++++++++++++++++++
 .../platform/graphics/qt/MediaPlayerPrivateQt.cpp  |    3 +++
 11 files changed, 102 insertions(+), 6 deletions(-)

diff --git a/qtbase/src/network/access/qhttpnetworkreply.cpp b/qtbase/src/network/access/qhttpnetworkreply.cpp
index eb8a886..1150088 100644
--- a/qtbase/src/network/access/qhttpnetworkreply.cpp
+++ b/qtbase/src/network/access/qhttpnetworkreply.cpp
@@ -238,8 +238,16 @@ void QHttpNetworkReply::setReadBufferSize(qint64 size)
 
 bool QHttpNetworkReply::supportsUserProvidedDownloadBuffer()
 {
+#ifdef Q_OS_GENODE
+	/*
+	 * Without this change Arora shows garbage when loading, for example,
+	 * www.genode.org
+	 */
+	return false;
+#else
     Q_D(QHttpNetworkReply);
     return (!d->isChunked() && !d->autoDecompress && d->bodyLength > 0 && d->statusCode == 200);
+#endif
 }
 
 void QHttpNetworkReply::setUserProvidedDownloadBuffer(char* b)
diff --git a/qtwebkit/Source/JavaScriptCore/dfg/DFGOperations.cpp b/qtwebkit/Source/JavaScriptCore/dfg/DFGOperations.cpp
index bb9ccc3..077cbed 100644
--- a/qtwebkit/Source/JavaScriptCore/dfg/DFGOperations.cpp
+++ b/qtwebkit/Source/JavaScriptCore/dfg/DFGOperations.cpp
@@ -1624,6 +1624,7 @@ namespace JSC {
 
 #if COMPILER(GCC) && CPU(X86_64)
 asm (
+".text" "\n" \
 ".globl " SYMBOL_STRING(getHostCallReturnValue) "\n"
 HIDE_SYMBOL(getHostCallReturnValue) "\n"
 SYMBOL_STRING(getHostCallReturnValue) ":" "\n"
diff --git a/qtwebkit/Source/WTF/wtf/Assertions.h b/qtwebkit/Source/WTF/wtf/Assertions.h
index 7e079ab..cac10fc 100644
--- a/qtwebkit/Source/WTF/wtf/Assertions.h
+++ b/qtwebkit/Source/WTF/wtf/Assertions.h
@@ -50,6 +50,10 @@
 #include <inttypes.h>
 #endif
 
+#if OS(GENODE)
+#include <base/printf.h>
+#endif
+
 #ifdef NDEBUG
 /* Disable ASSERT* macros in release mode. */
 #define ASSERTIONS_DISABLED_DEFAULT 1
@@ -173,6 +177,13 @@ WTF_EXPORT_PRIVATE void WTFInstallReportBacktraceOnCrashHook();
      WTFInvokeCrashHook(), \
      (*(int *)(uintptr_t)0xbbadbeef = 0), \
      __builtin_trap())
+#elif OS(GENODE)
+#define CRASH() ( \
+	PERR("WebKit CRASH in '%s'", WTF_PRETTY_FUNCTION), \
+	PERR("  in %s:%d", __FILE__, __LINE__), \
+    *(int *)(uintptr_t)0xbbadbeef = 0, \
+    ((void(*)())0)() /* More reliable, but doesn't say BBADBEEF */ \
+)
 #else
 #define CRASH() \
     (WTFReportBacktrace(), \
diff --git a/qtwebkit/Source/WTF/wtf/ExportMacros.h b/qtwebkit/Source/WTF/wtf/ExportMacros.h
index ef9bd23..37cd7bd 100644
--- a/qtwebkit/Source/WTF/wtf/ExportMacros.h
+++ b/qtwebkit/Source/WTF/wtf/ExportMacros.h
@@ -41,7 +41,7 @@
 #if !PLATFORM(CHROMIUM) && OS(WINDOWS)
 #define HAVE_INTERNAL_VISIBILITY 1
 #define WTF_INTERNAL
-#elif defined(__GNUC__) && !defined(__CC_ARM) && !defined(__ARMCC__)
+#elif defined(__GNUC__) && !defined(__CC_ARM) && !defined(__ARMCC__) && !OS(GENODE)
 #define HAVE_INTERNAL_VISIBILITY 1
 #define WTF_INTERNAL __attribute__((visibility("hidden")))
 #else
@@ -54,7 +54,7 @@
 #define WTF_IMPORT_DECLARATION __declspec(dllimport)
 #define WTF_HIDDEN_DECLARATION
 
-#elif defined(__GNUC__) && !defined(__CC_ARM) && !defined(__ARMCC__)
+#elif defined(__GNUC__) && !defined(__CC_ARM) && !defined(__ARMCC__) && !OS(GENODE)
 
 #define WTF_EXPORT_DECLARATION __attribute__((visibility("default")))
 #define WTF_IMPORT_DECLARATION WTF_EXPORT_DECLARATION
diff --git a/qtwebkit/Source/WTF/wtf/InlineASM.h b/qtwebkit/Source/WTF/wtf/InlineASM.h
index 0a2fe78..fe62990 100644
--- a/qtwebkit/Source/WTF/wtf/InlineASM.h
+++ b/qtwebkit/Source/WTF/wtf/InlineASM.h
@@ -62,12 +62,13 @@
 #elif OS(AIX)
     // IBM's own file format
 #define HIDE_SYMBOL(name) ".lglobl " #name
-#elif   OS(LINUX)               \
+#elif   (OS(LINUX)               \
      || OS(FREEBSD)             \
      || OS(OPENBSD)             \
      || OS(SOLARIS)             \
      || (OS(HPUX) && CPU(IA64)) \
-     || OS(NETBSD)
+     || OS(NETBSD))             \
+     && !OS(GENODE)
     // ELF platform
 #define HIDE_SYMBOL(name) ".hidden " #name
 #else
diff --git a/qtwebkit/Source/WTF/wtf/OSAllocatorPosix.cpp b/qtwebkit/Source/WTF/wtf/OSAllocatorPosix.cpp
index a2f6a79..be8fff9 100644
--- a/qtwebkit/Source/WTF/wtf/OSAllocatorPosix.cpp
+++ b/qtwebkit/Source/WTF/wtf/OSAllocatorPosix.cpp
@@ -120,6 +120,7 @@ void* OSAllocator::reserveAndCommit(size_t bytes, Usage usage, bool writable, bo
 #endif
             CRASH();
     }
+#if !OS(GENODE)
     if (result && includesGuardPages) {
         // We use mmap to remap the guardpages rather than using mprotect as
         // mprotect results in multiple references to the code region.  This
@@ -128,6 +129,7 @@ void* OSAllocator::reserveAndCommit(size_t bytes, Usage usage, bool writable, bo
         mmap(result, pageSize(), PROT_NONE, MAP_FIXED | MAP_PRIVATE | MAP_ANON, fd, 0);
         mmap(static_cast<char*>(result) + bytes - pageSize(), pageSize(), PROT_NONE, MAP_FIXED | MAP_PRIVATE | MAP_ANON, fd, 0);
     }
+#endif /* OS(GENODE) */
     return result;
 }
 
@@ -179,9 +181,20 @@ void OSAllocator::decommit(void* address, size_t bytes)
 
 void OSAllocator::releaseDecommitted(void* address, size_t bytes)
 {
+#if OS(GENODE)
+    /*
+     * 'releaseDecommitted()' sometimes gets called with a start address
+     * different than the one returned by 'mmap()' to release only a part of the
+     * allocated memory. This feature is currently not supported by Genode's
+     * 'munmap()' implementation, so we don't crash on purpose if the result of
+     * 'munmap()' is -1.
+     */
+    munmap(address, bytes);
+#else
     int result = munmap(address, bytes);
     if (result == -1)
         CRASH();
+#endif /* OS(GENODE) */
 }
 
 } // namespace WTF
diff --git a/qtwebkit/Source/WTF/wtf/OSRandomSource.cpp b/qtwebkit/Source/WTF/wtf/OSRandomSource.cpp
index 0c1416a..5a10b3d 100644
--- a/qtwebkit/Source/WTF/wtf/OSRandomSource.cpp
+++ b/qtwebkit/Source/WTF/wtf/OSRandomSource.cpp
@@ -29,6 +29,10 @@
 #include <stdint.h>
 #include <stdlib.h>
 
+#if OS(GENODE)
+#include <base/printf.h>
+#endif /* OS(GENODE) */
+
 #if OS(UNIX)
 #include <fcntl.h>
 #include <unistd.h>
@@ -44,6 +48,10 @@ namespace WTF {
 #if USE(OS_RANDOMNESS)
 void cryptographicallyRandomValuesFromOS(unsigned char* buffer, size_t length)
 {
+#if OS(GENODE)
+	PWRN("cryptographicallyRandomValuesFromOS(): no strong source of randomness available");
+	return;
+#endif /* OS(GENODE) */
 #if OS(UNIX)
     int fd = open("/dev/urandom", O_RDONLY, 0);
     if (fd < 0)
diff --git a/qtwebkit/Source/WTF/wtf/Platform.h b/qtwebkit/Source/WTF/wtf/Platform.h
index 35fa7e3..2d150fa 100644
--- a/qtwebkit/Source/WTF/wtf/Platform.h
+++ b/qtwebkit/Source/WTF/wtf/Platform.h
@@ -153,6 +153,7 @@
     || defined(_M_IX86)  \
     || defined(_X86_)    \
     || defined(__THW_INTEL)
+l
 #define WTF_CPU_X86 1
 #endif
 
@@ -426,6 +427,12 @@
 #define WTF_OS_UNIX 1
 #endif
 
+/* OS(GENODE) */
+#ifdef __GENODE__
+/* Note: WTF_OS_FREEBSD is defined, too */
+#define WTF_OS_GENODE 1
+#endif
+
 /* Operating environments */
 
 /* FIXME: these are all mixes of OS, operating environment and policy choices. */
@@ -699,7 +706,8 @@
 
 #if !OS(WINDOWS) && !OS(SOLARIS) \
     && !OS(RVCT) \
-    && !OS(ANDROID)
+    && !OS(ANDROID) \
+    && !OS(GENODE)
 #define HAVE_TM_GMTOFF 1
 #define HAVE_TM_ZONE 1
 #define HAVE_TIMEGM 1
@@ -764,6 +772,11 @@
 #define HAVE_SYS_PARAM_H 1
 #define HAVE_SYS_TIME_H 1
 
+#elif OS(GENODE)
+
+#define HAVE_ERRNO_H 1
+#define HAVE_SYS_TIME_H 1
+
 #else
 
 /* FIXME: is this actually used or do other platforms generate their own config.h? */
@@ -782,7 +795,7 @@
 #if PLATFORM(QT)
 /* We must not customize the global operator new and delete for the Qt port. */
 #define ENABLE_GLOBAL_FASTMALLOC_NEW 0
-#if !OS(UNIX)
+#if !OS(UNIX) || OS(GENODE)
 #define USE_SYSTEM_MALLOC 1
 #endif
 #endif
@@ -886,6 +899,11 @@
 #define ENABLE_JIT 1
 #endif
 
+/* Use LLINT on Genode */
+#if OS(GENODE)
+//#define ENABLE_JIT 0
+#endif
+
 /* The JIT is enabled by default on all x86, x86-64, ARM & MIPS platforms. */
 #if !defined(ENABLE_JIT) \
     && (CPU(X86) || CPU(X86_64) || CPU(ARM) || CPU(MIPS)) \
diff --git a/qtwebkit/Source/WTF/wtf/StackBounds.cpp b/qtwebkit/Source/WTF/wtf/StackBounds.cpp
index a272ce3..3c335d3 100644
--- a/qtwebkit/Source/WTF/wtf/StackBounds.cpp
+++ b/qtwebkit/Source/WTF/wtf/StackBounds.cpp
@@ -44,6 +44,10 @@
 #include <string.h>
 #include <sys/procfs.h>
 
+#elif OS(GENODE)
+
+#include <base/thread.h>
+
 #elif OS(UNIX)
 
 #include <pthread.h>
@@ -128,6 +132,14 @@ void StackBounds::initialize()
     m_bound = estimateStackBound(m_origin);
 }
 
+#elif OS(GENODE)
+
+void StackBounds::initialize()
+{
+    m_bound = Genode::Thread_base::myself()->stack_base();
+	m_origin = Genode::Thread_base::myself()->stack_top();
+}
+
 #elif OS(UNIX)
 
 void StackBounds::initialize()
diff --git a/qtwebkit/Source/WTF/wtf/TCSystemAlloc.cpp b/qtwebkit/Source/WTF/wtf/TCSystemAlloc.cpp
index f547085..07fc9b0 100644
--- a/qtwebkit/Source/WTF/wtf/TCSystemAlloc.cpp
+++ b/qtwebkit/Source/WTF/wtf/TCSystemAlloc.cpp
@@ -49,6 +49,12 @@
 #include <sys/mman.h>
 #endif
 
+#if OS(GENODE)
+#include <base/printf.h>
+#include <base/stdint.h>
+#include <util/misc_math.h>
+#endif
+
 #ifndef MAP_ANONYMOUS
 #define MAP_ANONYMOUS MAP_ANON
 #endif
@@ -367,6 +373,21 @@ void* TCMalloc_SystemAlloc(size_t size, size_t *actual_size, size_t alignment) {
     }
 #endif
 
+#if OS(GENODE)
+    if (actual_size)
+      *actual_size = size;
+
+    void* real_address = malloc(sizeof(Genode::addr_t) + size + alignment);
+    Genode::addr_t address = reinterpret_cast<Genode::addr_t>(real_address);
+    address += sizeof(Genode::addr_t);
+    address = Genode::align_addr(address, Genode::log2(alignment));
+    address -= sizeof(Genode::addr_t);
+    *(Genode::addr_t*)address = (Genode::addr_t)real_address;
+    address += sizeof(Genode::addr_t);
+
+    return (void*)address;;
+#endif
+
     // nothing worked - reset failure flags and try again
     devmem_failure = false;
     sbrk_failure = false;
diff --git a/qtwebkit/Source/WebCore/platform/graphics/qt/MediaPlayerPrivateQt.cpp b/qtwebkit/Source/WebCore/platform/graphics/qt/MediaPlayerPrivateQt.cpp
index e083e29..dc73aac 100644
--- a/qtwebkit/Source/WebCore/platform/graphics/qt/MediaPlayerPrivateQt.cpp
+++ b/qtwebkit/Source/WebCore/platform/graphics/qt/MediaPlayerPrivateQt.cpp
@@ -18,6 +18,8 @@
 */
 
 #include "config.h"
+
+#if ENABLE(VIDEO)
 #include "MediaPlayerPrivateQt.h"
 
 #include "Frame.h"
@@ -661,3 +663,4 @@ PlatformMedia MediaPlayerPrivateQt::platformMedia() const
 } // namespace WebCore
 
 #include "moc_MediaPlayerPrivateQt.cpp"
+#endif /* ENABLE(VIDEO) */
