qt5_qpa.patch

From: Christian Prochaska <christian.prochaska@genode-labs.com>


---
 .../fontdatabases/basic/qbasicfontdatabase.cpp     |    9 +++++++++
 .../evdevkeyboard/qevdevkeyboard_defaultmap_p.h    |    5 ++++-
 .../input/evdevkeyboard/qevdevkeyboardhandler.cpp  |   18 +++++++++++++++---
 .../input/evdevkeyboard/qevdevkeyboardhandler_p.h  |    2 ++
 qtbase/src/widgets/kernel/qwidget_qpa.cpp          |    2 +-
 5 files changed, 31 insertions(+), 5 deletions(-)

diff --git a/qtbase/src/platformsupport/fontdatabases/basic/qbasicfontdatabase.cpp b/qtbase/src/platformsupport/fontdatabases/basic/qbasicfontdatabase.cpp
index 26ae0eb..a1838f3 100644
--- a/qtbase/src/platformsupport/fontdatabases/basic/qbasicfontdatabase.cpp
+++ b/qtbase/src/platformsupport/fontdatabases/basic/qbasicfontdatabase.cpp
@@ -109,7 +109,16 @@ void QBasicFontDatabase::populateFontDatabase()
     for (int i = 0; i < int(dir.count()); ++i) {
         const QByteArray file = QFile::encodeName(dir.absoluteFilePath(dir[i]));
 //        qDebug() << "looking at" << file;
+#ifdef Q_OS_GENODE
+        QByteArray data;
+        QFile f(file);
+        if (!f.open(QIODevice::ReadOnly))
+            continue;
+        data = f.readAll();
+        addTTFile(data, file);
+#else
         addTTFile(QByteArray(), file);
+#endif
     }
 }
 
diff --git a/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboard_defaultmap_p.h b/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboard_defaultmap_p.h
index 5e919eb..17b22a6 100644
--- a/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboard_defaultmap_p.h
+++ b/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboard_defaultmap_p.h
@@ -43,7 +43,9 @@
 #define QEVDEVKEYBOARDHANDLER_DEFAULTMAP_P_H
 
 #include "qnamespace.h"
+#ifndef Q_OS_GENODE
 #include "linux/input.h"
+#endif /* Q_OS_GENODE */
 
 // no QT_BEGIN_NAMESPACE, since we include it internally...
 
@@ -634,7 +636,7 @@ const QEvdevKeyboardMap::Mapping QEvdevKeyboardHandler::s_keymap_default[] = {
     { 111, 0xffff, 0x01000007, 0x00, 0x00, 0x0000 },
     { 111, 0xffff, 0x01000000, 0x06, 0x08, 0x0200 },
     { 111, 0xffff, 0x01000000, 0x0c, 0x08, 0x0200 },
-
+#ifndef Q_OS_GENODE
     // 113 -> 248
     { KEY_MUTE,         0xffff, Qt::Key_VolumeMute,     0x00, 0x00, 0x0000 },
     { KEY_VOLUMEDOWN,   0xffff, Qt::Key_VolumeDown,     0x00, 0x00, 0x0000 },
@@ -663,6 +665,7 @@ const QEvdevKeyboardMap::Mapping QEvdevKeyboardHandler::s_keymap_default[] = {
     { KEY_BLUE,         0xffff, Qt::Key_Blue,           0x00, 0x00, 0x0000 },
     { KEY_CHANNELUP,    0xffff, Qt::Key_ChannelUp,      0x00, 0x00, 0x0000 },
     { KEY_CHANNELDOWN,  0xffff, Qt::Key_ChannelDown,    0x00, 0x00, 0x0000 },
+#endif
 };
 
 const QEvdevKeyboardMap::Composing QEvdevKeyboardHandler::s_keycompose_default[] = {
diff --git a/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler.cpp b/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler.cpp
index 0841544..2e0b863 100644
--- a/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler.cpp
+++ b/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler.cpp
@@ -49,7 +49,9 @@
 #include <QCoreApplication>
 #include <private/qcore_unix_p.h>
 
+#ifndef Q_OS_GENODE
 #include <linux/input.h>
+#endif /* Q_OS_GENODE */
 
 //#define QT_QPA_KEYMAP_DEBUG
 
@@ -78,11 +80,12 @@ QEvdevKeyboardHandler::QEvdevKeyboardHandler(const QString &device, int fd, bool
 
     if (keymapFile.isEmpty() || !loadKeymap(keymapFile))
         unloadKeymap();
-
+#ifndef Q_OS_GENODE
     // socket notifier for events on the keyboard device
     QSocketNotifier *notifier;
     notifier = new QSocketNotifier(m_fd, QSocketNotifier::Read, this);
     connect(notifier, SIGNAL(activated(int)), this, SLOT(readKeycode()));
+#endif /* Q_OS_GENODE */
 }
 
 QEvdevKeyboardHandler::~QEvdevKeyboardHandler()
@@ -92,7 +95,7 @@ QEvdevKeyboardHandler::~QEvdevKeyboardHandler()
     if (m_fd >= 0)
         qt_safe_close(m_fd);
 }
-
+#ifndef Q_OS_GENODE
 QEvdevKeyboardHandler *QEvdevKeyboardHandler::create(const QString &device, const QString &specification)
 {
 #ifdef QT_QPA_KEYMAP_DEBUG
@@ -218,10 +221,19 @@ void QEvdevKeyboardHandler::readKeycode()
         }
     }
 }
-
+#endif /* Q_OS_GENODE */
 void QEvdevKeyboardHandler::processKeyEvent(int nativecode, int unicode, int qtcode,
                                             Qt::KeyboardModifiers modifiers, bool isPress, bool autoRepeat)
 {
+#ifdef Q_OS_GENODE
+    /* characters are handled separately by the QPA plugin */
+    unicode = 0xffff;
+
+    /* Ctrl-A .. Ctrl-Z is handled separately by the QPA plugin */
+    if ((modifiers & Qt::ControlModifier) &&
+        ((qtcode >= Qt::Key_A) && (qtcode <= Qt::Key_Z)))
+        return;
+#endif
     QWindowSystemInterface::handleExtendedKeyEvent(0, (isPress ? QEvent::KeyPress : QEvent::KeyRelease),
                                                    qtcode, modifiers, nativecode + 8, 0, int(modifiers),
                                                    (unicode != 0xffff ) ? QString(unicode) : QString(), autoRepeat);
diff --git a/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler_p.h b/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler_p.h
index 1065b05..b395d46 100644
--- a/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler_p.h
+++ b/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler_p.h
@@ -161,8 +161,10 @@ public:
         return qtmod;
     }
 
+#ifndef Q_OS_GENODE
 private slots:
     void readKeycode();
+#endif /* Q_OS_GENODE */
     KeycodeAction processKeycode(quint16 keycode, bool pressed, bool autorepeat);
 
 private:
diff --git a/qtbase/src/widgets/kernel/qwidget_qpa.cpp b/qtbase/src/widgets/kernel/qwidget_qpa.cpp
index 5a4bd33..7819505 100644
--- a/qtbase/src/widgets/kernel/qwidget_qpa.cpp
+++ b/qtbase/src/widgets/kernel/qwidget_qpa.cpp
@@ -997,7 +997,7 @@ void QWidgetPrivate::registerDropSite(bool on)
 void QWidgetPrivate::setMask_sys(const QRegion &region)
 {
     if (!QGuiApplicationPrivate::platformIntegration()->hasCapability(QPlatformIntegration::WindowMasks)) {
-        qWarning("%s: Not supported on %s.", Q_FUNC_INFO, qPrintable(QGuiApplication::platformName()));
+        //qWarning("%s: Not supported on %s.", Q_FUNC_INFO, qPrintable(QGuiApplication::platformName()));
         return;
     }
     Q_Q(QWidget);
