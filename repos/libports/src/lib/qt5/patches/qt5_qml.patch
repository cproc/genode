qt5_qml.patch

From: Christian Prochaska <christian.prochaska@genode-labs.com>


---
 qtdeclarative/src/qml/jsruntime/qv4alloca_p.h      |    4 ++++
 qtdeclarative/src/qml/jsruntime/qv4engine.cpp      |    9 ++++++++-
 qtdeclarative/src/qml/jsruntime/qv4global_p.h      |    2 +-
 qtdeclarative/src/qml/jsruntime/qv4mm.cpp          |    4 ++++
 qtdeclarative/src/qml/qml/qqmlaccessors_p.h        |    2 +-
 qtdeclarative/src/qml/qml/qqmlimport.cpp           |    9 +++++++++
 .../graphics/transforms/TransformationMatrix.h     |    3 ++-
 7 files changed, 29 insertions(+), 4 deletions(-)

diff --git a/qtdeclarative/src/qml/jsruntime/qv4alloca_p.h b/qtdeclarative/src/qml/jsruntime/qv4alloca_p.h
index a453786..fc92e0b 100644
--- a/qtdeclarative/src/qml/jsruntime/qv4alloca_p.h
+++ b/qtdeclarative/src/qml/jsruntime/qv4alloca_p.h
@@ -36,6 +36,7 @@
 
 #include <qglobal.h>
 
+#ifndef Q_OS_GENODE
 #if defined(Q_OS_WIN)
 #  include <malloc.h>
 #  ifndef __GNUC__
@@ -43,6 +44,9 @@
 #  endif
 #elif !defined(Q_OS_BSD4) || defined(Q_OS_DARWIN)
 #  include <alloca.h>
+#else
+#  include <alloca.h>
+#endif
 #endif
 
 #endif
diff --git a/qtdeclarative/src/qml/jsruntime/qv4engine.cpp b/qtdeclarative/src/qml/jsruntime/qv4engine.cpp
index e1282ee..ce847c9 100644
--- a/qtdeclarative/src/qml/jsruntime/qv4engine.cpp
+++ b/qtdeclarative/src/qml/jsruntime/qv4engine.cpp
@@ -95,6 +95,10 @@
 #include <valgrind/memcheck.h>
 #endif
 
+#if defined(Q_OS_GENODE)
+#include <base/thread.h>
+#endif
+
 QT_BEGIN_NAMESPACE
 
 using namespace QV4;
@@ -114,7 +118,10 @@ QT_WARNING_DISABLE_MSVC(4172) // MSVC 2015: warning C4172: returning address of
 quintptr getStackLimit()
 {
     quintptr stackLimit;
-#if USE(PTHREADS) && !OS(QNX)
+#if defined(Q_OS_GENODE)
+	Genode::Thread::Stack_info stack_info = Genode::Thread::mystack();
+	stackLimit = reinterpret_cast<quintptr>(reinterpret_cast<void*>(stack_info.base));
+#elif USE(PTHREADS) && !OS(QNX)
 #  if OS(DARWIN)
     pthread_t thread_self = pthread_self();
     void *stackTop = pthread_get_stackaddr_np(thread_self);
diff --git a/qtdeclarative/src/qml/jsruntime/qv4global_p.h b/qtdeclarative/src/qml/jsruntime/qv4global_p.h
index 4b08194..4354090 100644
--- a/qtdeclarative/src/qml/jsruntime/qv4global_p.h
+++ b/qtdeclarative/src/qml/jsruntime/qv4global_p.h
@@ -92,7 +92,7 @@ inline double trunc(double d) { return d > 0 ? floor(d) : ceil(d); }
 
 // Black list some platforms
 #if defined(V4_ENABLE_JIT)
-#if defined(Q_OS_IOS) || defined(Q_OS_WINRT)
+#if defined(Q_OS_IOS) || defined(Q_OS_WINRT) || defined(Q_OS_GENODE)
 #    undef V4_ENABLE_JIT
 #endif
 #endif
diff --git a/qtdeclarative/src/qml/jsruntime/qv4mm.cpp b/qtdeclarative/src/qml/jsruntime/qv4mm.cpp
index 64491e1..6f05998 100644
--- a/qtdeclarative/src/qml/jsruntime/qv4mm.cpp
+++ b/qtdeclarative/src/qml/jsruntime/qv4mm.cpp
@@ -64,6 +64,10 @@
 #include <pthread_np.h>
 #endif
 
+#if defined(Q_OS_GENODE)
+#include <base/thread.h>
+#endif
+
 using namespace WTF;
 
 QT_BEGIN_NAMESPACE
diff --git a/qtdeclarative/src/qml/qml/qqmlaccessors_p.h b/qtdeclarative/src/qml/qml/qqmlaccessors_p.h
index 24cd0b6..0558983 100644
--- a/qtdeclarative/src/qml/qml/qqmlaccessors_p.h
+++ b/qtdeclarative/src/qml/qml/qqmlaccessors_p.h
@@ -40,7 +40,7 @@
 #include <QtCore/qhash.h>
 #include <QtCore/QReadWriteLock>
 
-#if defined(Q_OS_QNX) || defined(Q_OS_LINUX)
+#if defined(Q_OS_QNX) || defined(Q_OS_LINUX) || defined(Q_OS_GENODE)
 #include <stdint.h>
 #endif
 
diff --git a/qtdeclarative/src/qml/qml/qqmlimport.cpp b/qtdeclarative/src/qml/qml/qqmlimport.cpp
index ff48a10..d5e892b 100644
--- a/qtdeclarative/src/qml/qml/qqmlimport.cpp
+++ b/qtdeclarative/src/qml/qml/qqmlimport.cpp
@@ -1650,6 +1650,14 @@ QString QQmlImportDatabase::resolvePlugin(QQmlTypeLoader *typeLoader,
                                                   const QString &qmldirPath, const QString &qmldirPluginPath,
                                                   const QString &baseName)
 {
+#if defined(Q_OS_GENODE)
+
+    return resolvePlugin(typeLoader, qmldirPath, qmldirPluginPath, baseName,
+                         QStringList() << QLatin1String(".lib.so"),
+                         QLatin1String("qt5_"));
+
+#else
+
 #if defined(Q_OS_WIN)
     return resolvePlugin(typeLoader, qmldirPath, qmldirPluginPath, baseName,
                          QStringList()
@@ -1699,6 +1707,7 @@ QString QQmlImportDatabase::resolvePlugin(QQmlTypeLoader *typeLoader,
 # endif
 
 #endif
+#endif
 }
 
 /*!
diff --git a/qtwebkit/Source/WebCore/platform/graphics/transforms/TransformationMatrix.h b/qtwebkit/Source/WebCore/platform/graphics/transforms/TransformationMatrix.h
index 0f04b67..2f15e37 100644
--- a/qtwebkit/Source/WebCore/platform/graphics/transforms/TransformationMatrix.h
+++ b/qtwebkit/Source/WebCore/platform/graphics/transforms/TransformationMatrix.h
@@ -60,7 +60,8 @@ class LayoutRect;
 class FloatRect;
 class FloatQuad;
 
-#if CPU(X86_64)
+#if CPU(X86_64) && !OS(GENODE)
+/* malloc alignment constraints not met on Genode */
 #define TRANSFORMATION_MATRIX_USE_X86_64_SSE2
 #endif
 
