genode.patch

From: Christian Prochaska <christian.prochaska@genode-labs.com>


---
 falkon.pro                      |   22 +++++++++++----------
 src/config.h                    |   11 +++++++++++
 src/defines.pri                 |   21 ++++++++++++++------
 src/lib/app/mainapplication.cpp |   11 ++++++-----
 src/lib/lib.pro                 |   40 ++++++++++++++++++++++++++++++---------
 src/lib/tools/qztools.cpp       |    4 ++++
 src/main/main.cpp               |    4 ++++
 src/main/main.pro               |    5 +++--
 8 files changed, 84 insertions(+), 34 deletions(-)
 create mode 100644 src/config.h

diff --git a/falkon.pro b/falkon.pro
index fc6ab748..c4ef882c 100644
--- a/falkon.pro
+++ b/falkon.pro
@@ -6,16 +6,16 @@
 #
 #-------------------------------------------------
 
-lessThan(QT_VERSION, 5.8) {
-    error("Falkon requires at least Qt 5.8!")
-}
-
-lessThan(QT.webengine.VERSION, 5.8) {
-    error("Falkon requires at least QtWebEngine 5.8!")
-}
+#lessThan(QT_VERSION, 5.8) {
+#    error("Falkon requires at least Qt 5.8!")
+#}
+#
+#lessThan(QT.webengine.VERSION, 5.8) {
+#    error("Falkon requires at least QtWebEngine 5.8!")
+#}
 
 # Create plugins directory first on Mac / Linux
-mac|unix: system(test -d bin/plugins || mkdir bin/plugins)
+#mac|unix: system(test -d bin/plugins || mkdir bin/plugins)
 
 TEMPLATE = subdirs
 
@@ -25,10 +25,10 @@ src_lib.target = sub-src-lib
 src_main.subdir = src/main
 src_main.depends = sub-src-lib
 
-src_plugins.subdir = src/plugins
-src_plugins.depends = sub-src-lib
+#src_plugins.subdir = src/plugins
+#src_plugins.depends = sub-src-lib
 
-SUBDIRS += src_lib src_main src_plugins
+SUBDIRS += src_lib src_main #src_plugins
 
 mac: {
     macdeploysh.target = bundle
diff --git a/src/config.h b/src/config.h
new file mode 100644
index 00000000..4fc7b4da
--- /dev/null
+++ b/src/config.h
@@ -0,0 +1,11 @@
+/* config.h.  Generated by cmake from config.h.cmake  */
+
+#define FALKON_VERSION "2.1.99"
+#define FALKON_PLUGIN_PATH "/usr/local/lib/x86_64-linux-gnu/plugins/falkon"
+#define FALKON_GIT_REVISION "94739d1a"
+
+/* Enable portable build */
+/* #undef PORTABLE_BUILD */
+
+/* Disable DBus support */
+/* #undef DISABLE_DBUS */
diff --git a/src/defines.pri b/src/defines.pri
index c26a24e8..cf4c0cb3 100644
--- a/src/defines.pri
+++ b/src/defines.pri
@@ -1,9 +1,16 @@
-DESTDIR = $$PWD/../bin
+#DESTDIR = $$PWD/../bin
+#QZ_DESTDIR = $$DESTDIR
+#OBJECTS_DIR = $$PWD/../build
+#MOC_DIR = $$PWD/../build
+#RCC_DIR = $$PWD/../build
+#UI_DIR = $$PWD/../build
+
+DESTDIR = $$OUT_PWD/../..
 QZ_DESTDIR = $$DESTDIR
-OBJECTS_DIR = $$PWD/../build
-MOC_DIR = $$PWD/../build
-RCC_DIR = $$PWD/../build
-UI_DIR = $$PWD/../build
+#OBJECTS_DIR = .
+#MOC_DIR = .
+#RCC_DIR = .
+#UI_DIR = .
 
 # workaround for #849: see https://bugreports.qt-project.org/browse/QTBUG-23196
 mocinclude.CONFIG *= fix_target
@@ -15,11 +22,11 @@ DEFINES *= FALKON_VERSION=\\\"""$$QZ_VERSION"\\\""
 d_no_system_datapath = $$(NO_SYSTEM_DATAPATH)
 d_kde_integration = $$(KDE_INTEGRATION)
 d_gnome_integration = $$(GNOME_INTEGRATION)
-d_nox11 = $$(NO_X11)
+d_nox11 = "true"
 d_portable = $$(PORTABLE_BUILD)
 d_nonblock_dialogs = $$(NONBLOCK_JS_DIALOGS)
 d_use_lib_path = $$(USE_LIBPATH)
-d_disable_dbus = $$(DISABLE_DBUS)
+d_disable_dbus = "true"
 d_disable_updates_check = $$(DISABLE_UPDATES_CHECK)
 d_debug_build = $$(DEBUG_BUILD)
 d_prefix = $$(FALKON_PREFIX)
diff --git a/src/lib/app/mainapplication.cpp b/src/lib/app/mainapplication.cpp
index 7a122940..65f3082d 100644
--- a/src/lib/app/mainapplication.cpp
+++ b/src/lib/app/mainapplication.cpp
@@ -150,7 +150,7 @@ MainApplication::MainApplication(int &argc, char** argv)
 
     bool noAddons = false;
     bool newInstance = false;
-
+#if 0
     if (argc > 1) {
         CommandLineOptions cmd;
         foreach (const CommandLineOptions::ActionPair &pair, cmd.getActions()) {
@@ -205,7 +205,7 @@ MainApplication::MainApplication(int &argc, char** argv)
             }
         }
     }
-
+#endif
     if (isPortable()) {
         std::cout << "Falkon: Running in Portable Mode." << std::endl;
         DataPaths::setPortableVersion();
@@ -242,7 +242,7 @@ MainApplication::MainApplication(int &argc, char** argv)
     if (messages.isEmpty()) {
         messages.append(QLatin1String(" "));
     }
-
+#if 0
     if (isRunning()) {
         m_isClosing = true;
         foreach (const QString &message, messages) {
@@ -250,6 +250,7 @@ MainApplication::MainApplication(int &argc, char** argv)
         }
         return;
     }
+#endif
 
 #ifdef Q_OS_MACOS
     setQuitOnLastWindowClosed(false);
@@ -662,9 +663,9 @@ void MainApplication::startPrivateBrowsing(const QUrl &startUrl)
         args << url.toEncoded();
     }
 
-    if (!QProcess::startDetached(applicationFilePath(), args)) {
+    //if (!QProcess::startDetached(applicationFilePath(), args)) {
         qWarning() << "MainApplication: Cannot start new browser process for private browsing!" << applicationFilePath() << args;
-    }
+    //}
 }
 
 void MainApplication::reloadUserStyleSheet()
diff --git a/src/lib/lib.pro b/src/lib/lib.pro
index 52de094a..d682e1f6 100644
--- a/src/lib/lib.pro
+++ b/src/lib/lib.pro
@@ -8,12 +8,12 @@ DEFINES *= FALKON_SHAREDLIBRARY
 CONFIG += c++14
 
 include(../defines.pri)
-include(../../translations/translations.pri)
+#include(../../translations/translations.pri)
 include(3rdparty/qtsingleapplication/qtsingleapplication.pri)
 
 CONFIG(debug, debug|release): include(../../tests/modeltest/modeltest.pri)
 
-unix:!contains(DEFINES, "DISABLE_DBUS") QT += dbus
+#unix:!contains(DEFINES, "DISABLE_DBUS") QT += dbus
 
 INCLUDEPATH += 3rdparty \
                adblock \
@@ -54,6 +54,7 @@ SOURCES += \
     adblock/adblockicon.cpp \
     adblock/adblockmanager.cpp \
     adblock/adblockmatcher.cpp \
+    adblock/adblockplugin.cpp \
     adblock/adblockrule.cpp \
     adblock/adblocksearchtree.cpp \
     adblock/adblocksubscription.cpp \
@@ -103,6 +104,7 @@ SOURCES += \
     downloads/downloaditem.cpp \
     downloads/downloadmanager.cpp \
     downloads/downloadoptionsdialog.cpp \
+    downloads/downloadsbutton.cpp \
     history/history.cpp \
     history/historyitem.cpp \
     history/historymanager.cpp \
@@ -119,13 +121,15 @@ SOURCES += \
     navigation/locationbar.cpp \
     navigation/locationbarpopup.cpp \
     navigation/navigationbar.cpp \
+    navigation/navigationbarconfigdialog.cpp \
+    navigation/navigationbartoolbutton.cpp \
     navigation/navigationcontainer.cpp \
     navigation/reloadstopbutton.cpp \
     navigation/siteicon.cpp \
     navigation/websearchbar.cpp \
     network/networkmanager.cpp \
-    network/networkproxyfactory.cpp \
     network/networkurlinterceptor.cpp \
+    network/schemehandlers/extensionschemehandler.cpp \
     network/schemehandlers/falkonschemehandler.cpp \
     network/sslerrordialog.cpp \
     notifications/desktopnotification.cpp \
@@ -145,7 +149,7 @@ SOURCES += \
     other/qzsettings.cpp \
     other/siteinfo.cpp \
     other/siteinfowidget.cpp \
-    other/statusbarmessage.cpp \
+    other/statusbar.cpp \
     other/updater.cpp \
     other/useragentmanager.cpp \
     plugins/pluginproxy.cpp \
@@ -172,18 +176,25 @@ SOURCES += \
     sidebar/sidebar.cpp \
     tabwidget/combotabbar.cpp \
     tabwidget/tabbar.cpp \
+    tabwidget/tabcontextmenu.cpp \
     tabwidget/tabicon.cpp \
+    tabwidget/tabmodel.cpp \
+    tabwidget/tabmrumodel.cpp \
     tabwidget/tabstackedwidget.cpp \
+    tabwidget/tabtreemodel.cpp \
     tabwidget/tabwidget.cpp \
+    tools/abstractbuttoninterface.cpp \
     tools/aesinterface.cpp \
     tools/animatedwidget.cpp \
     tools/buttonbox.cpp \
     tools/buttonwithmenu.cpp \
     tools/certificateinfowidget.cpp \
     tools/clickablelabel.cpp \
+    tools/closedwindowsmanager.cpp \
     tools/closedtabsmanager.cpp \
     tools/colors.cpp \
     tools/delayedfilewatcher.cpp \
+    tools/desktopfile.cpp \
     tools/docktitlebarwidget.cpp \
     tools/emptynetworkreply.cpp \
     tools/enhancedmenu.cpp \
@@ -200,7 +211,6 @@ SOURCES += \
     tools/menubar.cpp \
     tools/pagethumbnailer.cpp \
     tools/progressbar.cpp \
-    tools/qzregexp.cpp \
     tools/qztools.cpp \
     tools/removeitemfocusdelegate.cpp \
     tools/scripts.cpp \
@@ -235,6 +245,7 @@ HEADERS  += \
     adblock/adblockicon.h \
     adblock/adblockmanager.h \
     adblock/adblockmatcher.h \
+    adblock/adblockplugin.h \
     adblock/adblockrule.h \
     adblock/adblocksearchtree.h \
     adblock/adblocksubscription.h \
@@ -284,6 +295,7 @@ HEADERS  += \
     downloads/downloaditem.h \
     downloads/downloadmanager.h \
     downloads/downloadoptionsdialog.h \
+    downloads/downloadsbutton.h \
     history/history.h \
     history/historyitem.h \
     history/historymanager.h \
@@ -300,13 +312,15 @@ HEADERS  += \
     navigation/locationbar.h \
     navigation/locationbarpopup.h \
     navigation/navigationbar.h \
+    navigation/navigationbarconfigdialog.h \
+    navigation/navigationbartoolbutton.h \
     navigation/navigationcontainer.h \
     navigation/reloadstopbutton.h \
     navigation/siteicon.h \
     navigation/websearchbar.h \
     network/networkmanager.h \
-    network/networkproxyfactory.h \
     network/networkurlinterceptor.h \
+    network/schemehandlers/extensionschemehandler.h \
     network/schemehandlers/falkonschemehandler.h \
     network/urlinterceptor.h \
     network/sslerrordialog.h \
@@ -327,7 +341,7 @@ HEADERS  += \
     other/qzsettings.h \
     other/siteinfo.h \
     other/siteinfowidget.h \
-    other/statusbarmessage.h \
+    other/statusbar.h \
     other/updater.h \
     other/useragentmanager.h \
     plugins/plugininterface.h \
@@ -356,18 +370,25 @@ HEADERS  += \
     sidebar/sidebarinterface.h \
     tabwidget/combotabbar.h \
     tabwidget/tabbar.h \
+    tabwidget/tabcontextmenu.h \
     tabwidget/tabicon.h \
+    tabwidget/tabmodel.h \
+    tabwidget/tabmrumodel.h \
     tabwidget/tabstackedwidget.h \
+    tabwidget/tabtreemodel.h \
     tabwidget/tabwidget.h \
+    tools/abstractbuttoninterface.h \
     tools/aesinterface.h \
     tools/animatedwidget.h \
     tools/buttonbox.h \
     tools/buttonwithmenu.h \
     tools/certificateinfowidget.h \
     tools/clickablelabel.h \
+    tools/closedwindowsmanager.h \
     tools/closedtabsmanager.h \
     tools/colors.h \
     tools/delayedfilewatcher.h \
+    tools/desktopfile.h \
     tools/docktitlebarwidget.h \
     tools/emptynetworkreply.h \
     tools/enhancedmenu.h \
@@ -384,7 +405,6 @@ HEADERS  += \
     tools/menubar.h \
     tools/pagethumbnailer.h \
     tools/progressbar.h \
-    tools/qzregexp.h \
     tools/qztools.h \
     tools/removeitemfocusdelegate.h \
     tools/scripts.h \
@@ -421,6 +441,7 @@ FORMS    += \
     downloads/downloadmanager.ui \
     downloads/downloadoptionsdialog.ui \
     history/historymanager.ui \
+    navigation/navigationbarconfigdialog.ui \
     network/sslerrordialog.ui \
     notifications/desktopnotification.ui \
     opensearch/editsearchengine.ui \
@@ -452,12 +473,13 @@ FORMS    += \
     webtab/searchtoolbar.ui \
 
 RESOURCES += \
+	adblock/adblock.qrc \
     data/data.qrc \
     data/html.qrc \
     data/icons.qrc \
     data/breeze-fallback.qrc
 
-!mac:unix {
+!mac:!genode:unix {
     target.path = $$library_folder
 
     INSTALLS += target
diff --git a/src/lib/tools/qztools.cpp b/src/lib/tools/qztools.cpp
index f1884ad8..d70a16f3 100644
--- a/src/lib/tools/qztools.cpp
+++ b/src/lib/tools/qztools.cpp
@@ -806,6 +806,7 @@ QStringList QzTools::splitCommandArguments(const QString &command)
 
 bool QzTools::startExternalProcess(const QString &executable, const QString &args)
 {
+#if 0
     const QStringList arguments = splitCommandArguments(args);
 
     bool success = QProcess::startDetached(executable, arguments);
@@ -820,6 +821,9 @@ bool QzTools::startExternalProcess(const QString &executable, const QString &arg
     }
 
     return success;
+#else
+	return false;
+#endif
 }
 
 void QzTools::setWmClass(const QString &name, const QWidget* widget)
diff --git a/src/main/main.cpp b/src/main/main.cpp
index c1af1b6f..14ac8564 100644
--- a/src/main/main.cpp
+++ b/src/main/main.cpp
@@ -22,6 +22,7 @@
 #include <QMessageBox> // For QT_REQUIRE_VERSION
 #include <iostream>
 
+#if 0
 #if defined(Q_OS_LINUX) || defined(__GLIBC__) || defined(__FreeBSD__) || defined(__HAIKU__)
 #include <signal.h>
 #include <execinfo.h>
@@ -94,6 +95,7 @@ void falkon_signal_handler(int s)
     std::cout << "Backtrace successfully saved in " << qPrintable(dir.absoluteFilePath(file.fileName())) << std::endl;
 }
 #endif // defined(Q_OS_LINUX) || defined(__GLIBC__) || defined(__FreeBSD__)
+#endif
 
 #ifndef Q_OS_WIN
 void msgHandler(QtMsgType type, const QMessageLogContext &context, const QString &msg)
@@ -129,8 +131,10 @@ int main(int argc, char* argv[])
     qInstallMessageHandler(&msgHandler);
 #endif
 
+#if 0
 #if defined(Q_OS_LINUX) || defined(__GLIBC__) || defined(__FreeBSD__)
     signal(SIGSEGV, falkon_signal_handler);
+#endif
 #endif
 
     // Hack to fix QT_STYLE_OVERRIDE with QProxyStyle
diff --git a/src/main/main.pro b/src/main/main.pro
index ee9ae20b..a2667c6f 100644
--- a/src/main/main.pro
+++ b/src/main/main.pro
@@ -12,10 +12,11 @@ LIBS += $$QZ_DESTDIR/libFalkon.la
 }
 else {
 !unix|mac: LIBS += -L$$QZ_DESTDIR -lFalkon
-!mac:unix: LIBS += $$QZ_DESTDIR/libFalkon.so
+!mac:!genode:unix: LIBS += $$QZ_DESTDIR/libFalkon.so
+genode: LIBS += $$QZ_DESTDIR/libFalkon.lib.so
 }
 
-unix:!contains(DEFINES, "DISABLE_DBUS") QT += dbus
+#unix:!contains(DEFINES, "DISABLE_DBUS") QT += dbus
 
 INCLUDEPATH += ../lib/3rdparty \
                ../lib/app \
