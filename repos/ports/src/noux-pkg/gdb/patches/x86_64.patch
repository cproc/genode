gdb_x86_64.diff

From: Christian Prochaska <christian.prochaska@genode-labs.com>


---
 gdb/amd64-tdep.c |    5 +++++
 gdb/defs.h       |    1 +
 gdb/i386-tdep.c  |    5 +++++
 gdb/osabi.c      |    6 ++++++
 4 files changed, 17 insertions(+)

diff --git a/gdb/amd64-tdep.c b/gdb/amd64-tdep.c
index 523119d..e202c16 100644
--- a/gdb/amd64-tdep.c
+++ b/gdb/amd64-tdep.c
@@ -3159,6 +3159,11 @@ void _initialize_amd64_tdep (void);
 void
 _initialize_amd64_tdep (void)
 {
+  /* Genode */
+  gdbarch_register_osabi(bfd_arch_i386, bfd_mach_x86_64,
+                         GDB_OSABI_GENODE, amd64_init_abi);
+  /* /Genode */
+
   initialize_tdesc_amd64 ();
   initialize_tdesc_amd64_avx ();
   initialize_tdesc_amd64_mpx ();
diff --git a/gdb/defs.h b/gdb/defs.h
index b7e9ff4..c90f5ab 100644
--- a/gdb/defs.h
+++ b/gdb/defs.h
@@ -589,6 +589,7 @@ enum gdb_osabi
   GDB_OSABI_OPENVMS,
   GDB_OSABI_LYNXOS178,
   GDB_OSABI_NEWLIB,
+  GDB_OSABI_GENODE,
 
   GDB_OSABI_INVALID		/* keep this last */
 };
diff --git a/gdb/i386-tdep.c b/gdb/i386-tdep.c
index 45637f0..0023504 100644
--- a/gdb/i386-tdep.c
+++ b/gdb/i386-tdep.c
@@ -8664,6 +8664,11 @@ is \"default\"."),
   gdbarch_register_osabi (bfd_arch_i386, 0, GDB_OSABI_GO32,
 			  i386_go32_init_abi);
 
+  /* Genode */
+  gdbarch_register_osabi(bfd_arch_i386, 0,  GDB_OSABI_GENODE,
+                         i386_elf_init_abi);
+  /* /Genode */
+
   /* Initialize the i386-specific register groups.  */
   i386_init_reggroups ();
 
diff --git a/gdb/osabi.c b/gdb/osabi.c
index 5b69eeb..2dfa22e 100644
--- a/gdb/osabi.c
+++ b/gdb/osabi.c
@@ -74,6 +74,7 @@ static const char * const gdb_osabi_names[] =
   "OpenVMS",
   "LynxOS178",
   "Newlib",
+  "Genode",
 
   "<invalid>"
 };
@@ -542,6 +543,11 @@ generic_elf_osabi_sniffer (bfd *abfd)
       bfd_map_over_sections (abfd,
 			     generic_elf_osabi_sniff_abi_tag_sections,
 			     &osabi);
+/* Genode */
+      if (osabi == GDB_OSABI_UNKNOWN)
+        osabi = GDB_OSABI_GENODE;
+/* /Genode */
+
       break;
 
     case ELFOSABI_FREEBSD:
