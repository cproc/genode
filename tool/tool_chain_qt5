#!/usr/bin/make -f
#
# \brief  Tool for preparing the Qt5 tool-chain for the Genode OS Framework
# \author Christian Prochaska
# \date   2018-01-03
#

SHELL   = bash
ECHO    = @echo -e
VERBOSE = @

help:
	$(ECHO)
	$(ECHO) "Build Qt5 tools for the Genode OS Framework tool chain"
	$(ECHO)
	$(ECHO) "--- available commands ---"
	$(ECHO) "build         - build Qt5 tools"
	$(ECHO) "install       - install Qt5 tools to '$(INSTALL_LOCATION)'"
	$(ECHO) "clean         - clean everything except contrib sources"
	$(ECHO)
	$(ECHO) "--- available command line options ---"
	$(ECHO) "MAKE_JOBS=4 - number of parallel make jobs (default: 4)"
	$(ECHO)

.PHONY: build help install

#
# Enable parallel build for 2nd-level $(MAKE) by default
#

MAKE_JOBS ?= 4

#
# Source, build and install location
#

GENODE_DIR       ?= $(realpath $(dir $(firstword $(MAKEFILE_LIST)))/..)
CONTRIB_DIR       = $(shell $(GENODE_DIR)/tool/ports/current qt5)/src/lib/qt5/qt5
BUILD_DIR         = $(GENODE_DIR)/build/tool/qt5-5.8.0
INSTALL_LOCATION  = /usr/local/genode-qt5

$(CONTRIB_DIR)/configure:
	$(VERBOSE)$(GENODE_DIR)/tool/ports/prepare_port qt5

QMAKE = $(BUILD_DIR)/qtbase/bin/qmake

$(QMAKE): $(CONTRIB_DIR)/configure
	$(VERBOSE)mkdir -p $(BUILD_DIR)
	$(VERBOSE)cd $(BUILD_DIR) && $(CONTRIB_DIR)/configure -opensource -confirm-license -no-iconv -no-opengl

$(BUILD_DIR)/qtbase/Makefile: $(QMAKE)
	$(VERBOSE)cd $(BUILD_DIR)/qtbase && \
	          $(QMAKE) -o Makefile \
	          $(CONTRIB_DIR)/qtbase/qtbase.pro -qtconf $(BUILD_DIR)/qtbase/bin/qt.conf -- -opensource

$(BUILD_DIR)/qtbase/src/Makefile: $(BUILD_DIR)/qtbase/Makefile
	$(VERBOSE)cd $(BUILD_DIR)/qtbase/src && \
	          $(QMAKE) -o Makefile \
	          $(CONTRIB_DIR)/qtbase/src/src.pro -qtconf $(BUILD_DIR)/qtbase/bin/qt.conf -- -opensource

$(BUILD_DIR)/qtbase/bin/moc: $(BUILD_DIR)/qtbase/src/Makefile
	$(VERBOSE)cd $(BUILD_DIR)/qtbase/src && \
	          make -j$(MAKE_JOBS) sub-moc

$(BUILD_DIR)/qtbase/bin/rcc: $(BUILD_DIR)/qtbase/src/Makefile
	$(VERBOSE)cd $(BUILD_DIR)/qtbase/src && \
	          make -j$(MAKE_JOBS) sub-rcc

$(BUILD_DIR)/qtbase/bin/uic: $(BUILD_DIR)/qtbase/src/Makefile
	$(VERBOSE)cd $(BUILD_DIR)/qtbase/src && \
	          make -j$(MAKE_JOBS) sub-uic

build: $(BUILD_DIR)/qtbase/bin/moc \
       $(BUILD_DIR)/qtbase/bin/rcc \
       $(BUILD_DIR)/qtbase/bin/uic

$(INSTALL_LOCATION)/bin/moc: $(BUILD_DIR)/qtbase/bin/moc
	$(VERBOSE)cd $(BUILD_DIR)/qtbase/src && \
              sudo make INSTALL_ROOT=$(INSTALL_LOCATION) sub-moc-install_subtargets

$(INSTALL_LOCATION)/bin/rcc: $(BUILD_DIR)/qtbase/bin/rcc
	$(VERBOSE)cd $(BUILD_DIR)/qtbase/src && \
              sudo make INSTALL_ROOT=$(INSTALL_LOCATION) sub-rcc-install_subtargets

$(INSTALL_LOCATION)/bin/uic: $(BUILD_DIR)/qtbase/bin/uic
	$(VERBOSE)cd $(BUILD_DIR)/qtbase/src && \
              sudo make INSTALL_ROOT=$(INSTALL_LOCATION) sub-uic-install_subtargets

install: $(INSTALL_LOCATION)/bin/moc \
         $(INSTALL_LOCATION)/bin/rcc \
         $(INSTALL_LOCATION)/bin/uic

clean:
	rm -rf $(BUILD_DIR)
